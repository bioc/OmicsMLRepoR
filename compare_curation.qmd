---
title: "Uncurated Metadata vs. Curated Metadata with Ontology Incorporation"
format: html
---

```{r setup}
library(curatedMetagenomicData)
library(OmicsMLRepoR)
```

```{r load_metadata}
# Uncurated metadata: curatedMetagenomicData
raw_metadata <- curatedMetagenomicData::sampleMetadata

# Harmonized and curated metadata: curatedMetagenomicData
curated_metadata <- OmicsMLRepoR::getMetadata("cMD")
```

```{r examine_meta}
# View "disease" values in each dataset
unique(unlist(strsplit(raw_metadata$disease, split = ";")))
unique(unlist(strsplit(curated_metadata$disease, split = ";")))
```

Both datasets have various intestinal disorders as "disease" values. Say we want
to filter the datasets and select only those rows whose "disease" values can be
classified as an "intestinal disorder".

A first attempt might use the "ontology_filter" function, which leverages the
EMBL-EBI Ontology Lookup Service (OLS) to detect terms that may be related to
the query.

onto_filter: Performs a search of the OLS database with "query" and filters
specified metadata column by returned term labels.

```{r onto_filter}
# First attempt with query = "Intestinal Disorder"
raw_onto_general <- raw_metadata |> onto_filter(disease, "Intestinal Disorder")
curated_onto_general <- curated_metadata |> onto_filter(disease, "Intestinal Disorder")

nrow(raw_onto_general)
nrow(curated_onto_general)

# Second attempt with vectors of more specific query terms
raw_onto_direct <- raw_metadata |> onto_filter(disease, c("irritable_bowel", "IBD", "coeliac"))
curated_onto_direct <- curated_metadata |> onto_filter(disease, c("Inflammatory Bowel Disease", "Irritable Bowel Syndrome"))

nrow(raw_onto_direct)
nrow(curated_onto_direct)

table(raw_onto_direct$disease)
table(curated_onto_direct$disease)
```

We can't be sure that we've covered all of the terms however, so this is where
we turn to our "curated_filter" function. This function accesses information
about the curated ontology terms used in the curated dataset, including their
hierarchical relationships to one another. This allows us to enter a general
query, such as the "Intestinal Disorder" query that returned no results
previously, and receive as results rows that contain child terms of this query.

curated_filter: Performs a search of the OLS database with "query" and filters
specified metadata column by returned term ids. Ontology terms that have the
returned terms as ancestors are included in the results.

```{r curated_filter}
curated_ancestors <- curated_metadata |> curated_filter(disease, "Intestinal Disorder", "cMD")
nrow(curated_ancestors)
table(curated_ancestors$disease)
```


